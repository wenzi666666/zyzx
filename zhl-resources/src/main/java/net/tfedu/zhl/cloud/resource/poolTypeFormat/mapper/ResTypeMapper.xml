<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="net.tfedu.zhl.cloud.resource.poolTypeFormat.dao.ResTypeMapper" >
  <resultMap id="BaseResultMap" type="net.tfedu.zhl.cloud.resource.poolTypeFormat.entity.ResType" >
    <!--
      WARNING - @mbggenerated
    -->
    <constructor >
      <idArg column="ID" jdbcType="INTEGER" javaType="java.lang.Integer" />
      <arg column="MType" jdbcType="CHAR" javaType="java.lang.String" />
      <arg column="code" jdbcType="CHAR" javaType="java.lang.String" />
      <arg column="description" jdbcType="VARCHAR" javaType="java.lang.String" />
      <arg column="flag" jdbcType="BIT" javaType="java.lang.Boolean" />
      <arg column="PId" jdbcType="BIGINT" javaType="java.lang.Long" />
      <arg column="Level" jdbcType="INTEGER" javaType="java.lang.Integer" />
      <arg column="TypeFlag" jdbcType="BIT" javaType="java.lang.Boolean" />
      <arg column="RoleId" jdbcType="BIGINT" javaType="java.lang.Long" />
      <arg column="SchoolId" jdbcType="BIGINT" javaType="java.lang.Long" />
      <arg column="SubjectId" jdbcType="BIGINT" javaType="java.lang.Long" />
      <arg column="DisplayIndex" jdbcType="TINYINT" javaType="java.lang.Byte" />
    </constructor>
  </resultMap>
  
  <!--  **************************  系统资源    类型相关   ************************** -->
  
  <!-- 系统资源：当资源库选择  “全部” 或  “教学素材” 时，显示所有一级类型   -->
  <resultMap id="FirstTypeResultMap"  type="net.tfedu.zhl.cloud.resource.poolTypeFormat.entity.ResType">
       <id column="id" property="id" />
	   <result column="mtype" property="mtype" />
  </resultMap>
  <select id="getSysFirstLevelType"  resultMap="FirstTypeResultMap">
  select DISTINCT id,mtype from (
  select case when temp.pid = 0 then temp.id else temp.pid end id,case when temp.pid = 0 then temp.mtype else temp.pmtype end mtype from 
  (select DISTINCT a.mtype from z_resource a 
  left join z_resnav c on a.ResCode=c.ResCode
  where a.flag = 0 and c.StructCode like CONCAT(#{pTfcode},'%') and a.fromFlag in 
  <foreach item="item" index="index" collection="sys_from" 
                         open="(" separator="," close=")">
                         #{item}
                </foreach>
  ) as tmp left join          
  (
  SELECT b.id,b.mtype,b.pid,case when b.pid = 0 then b.mtype else pb.mtype end pmtype,a.poolId,b.DisplayIndex 
  from z_res_pooltype a 
  LEFT JOIN x_resourcetype b on a.resTypeId = b.id
  left JOIN x_resourcetype pb on b.pid = pb.id 
  where a.flag=0 and b.flag=0 

  <if test="poolId != 0">   <!-- poolId == 0 时，查询全部资源库下的资源类型 -->
          and poolId = #{poolId} 
     </if>
  UNION 
  SELECT a.id,a.mtype,a.pid, case when a.pid = 0 then a.mtype else pb.mtype end pmtype,b.poolId,a.DisplayIndex  
  from z_res_pooltype b  
  LEFT JOIN x_resourcetype a on a.pid = b.resTypeId 
  left JOIN x_resourcetype pb on a.pid = pb.id 
  where a.flag=0 and b.flag=0 
  <if test="poolId != 0">   <!-- poolId == 0 时，查询全部资源库下的资源类型 -->
          and poolId = #{poolId} 
     </if>

  ) as temp 
  on temp.id = tmp.mtype 
  ) tmpType where id is not null;

   <!--  select distinct case when b.PId=0 then b.MType ELSE pb.MType END mtype,case when b.PId=0 then b.id ELSE pb.id END id
	from z_resource a 
	left join x_resourcetype b on a.MType = b.id and b.flag = 0
	left join x_resourcetype pb on pb.Id=b.pid 
	where a.flag = 0 and b.MType is not null and pb.MType is not null

     <if test="resourceIds.size() == 0">
         and a.id in ('')
     </if>
     <if test="resourceIds.size() > 0 ">
         and a.id in
                <foreach item="item" index="index" collection="resourceIds" 
                         open="(" separator="," close=")">
                         #{item}
                </foreach>
         <if test="typeIds.size() > 0">
          and a.mtype in
                <foreach item="item" index="index" collection="typeIds" 
                         open="(" separator="," close=")">
                         #{item}
                </foreach> 
         </if>
     </if> -->
  </select>
  
  <!-- e备课， 系统资源：当资源库选择  “全部” 或  “教学素材” 时，显示所有一级类型   -->
  <select id="getSysFirstLevelType_ePrepare"  resultMap="FirstTypeResultMap">
  select DISTINCT id,mtype from (
  select case when temp.pid = 0 then temp.id else temp.pid end id,case when temp.pid = 0 then temp.mtype else temp.pmtype end mtype from 
  (select DISTINCT a.mtype from z_resource a 
  left join z_resnav c on a.ResCode=c.ResCode
  where a.flag = 0 and c.StructCode like CONCAT(#{pTfcode},'%') and a.fromFlag in 
  <foreach item="item" index="index" collection="sys_from" 
                         open="(" separator="," close=")">
                         #{item}
                </foreach>
  ) as tmp left join          
 (
  SELECT b.id,b.mtype,b.pid,case when b.pid = 0 then b.mtype else pb.mtype end pmtype,a.poolId,b.DisplayIndex 
  from z_res_pooltype a 
  LEFT JOIN x_resourcetype b on a.resTypeId = b.id
  left JOIN x_resourcetype pb on b.pid = pb.id 
  where a.flag=0 and b.flag=0 

  <if test="poolId != 0">   <!-- poolId == 0 时，查询全部资源库下的资源类型 -->
          and poolId = #{poolId} 
     </if>
  UNION 
  SELECT a.id,a.mtype,a.pid, case when a.pid = 0 then a.mtype else pb.mtype end pmtype,b.poolId,a.DisplayIndex  
  from z_res_pooltype b  
  LEFT JOIN x_resourcetype a on a.pid = b.resTypeId 
  left JOIN x_resourcetype pb on a.pid = pb.id 
  where a.flag=0 and b.flag=0 
  <if test="poolId != 0">   <!-- poolId == 0 时，查询全部资源库下的资源类型 -->
          and poolId = #{poolId} 
     </if>
  ) as temp on temp.id = tmp.mtype 
  ) tmpType where id is not null 
  <if test="removeTypes.size() > 0">   <!-- e备课，去除一些特定类型 -->
          and id not in <foreach item="item" index="index" collection="removeTypes" 
                         open="(" separator="," close=")">
                         #{item}
                </foreach>
     </if>;
  </select>
    
    
  <!-- 系统资源：当资源库选择  “动画焦教具”、“名师微课”、“教学案例” 时，显示所有二级类型。 当资源库为“理化生实验”时，只显示“全部”。 -->
  <select id="getSysSecondLevelType"  resultMap="FirstTypeResultMap">
  select DISTINCT id,mtype from (
  select temp.id,temp.mtype from 
  (select DISTINCT a.mtype from z_resource a 
  left join z_resnav c on a.ResCode=c.ResCode
  where a.flag = 0 and c.StructCode like CONCAT(#{pTfcode},'%') and a.fromFlag in 
  <foreach item="item" index="index" collection="sys_from" 
                         open="(" separator="," close=")">
                         #{item}
                </foreach>
  
  ) as tmp
  left join
  (
  SELECT b.id,b.mtype
  from z_res_pooltype a 
  LEFT JOIN x_resourcetype b on a.resTypeId = b.id
  where a.flag=0 and b.flag=0 
   <if test="poolId != 0">   <!-- poolId == 0 时，查询全部资源库下的资源类型 -->
          and poolId = #{poolId} 
     </if>
  UNION 

  SELECT a.id,a.mtype
  from z_res_pooltype b  
  LEFT JOIN x_resourcetype a on a.pid = b.resTypeId 
  where a.flag=0 and b.flag=0 
   <if test="poolId != 0">   <!-- poolId == 0 时，查询全部资源库下的资源类型 -->
          and poolId = #{poolId} 
     </if>
  ) as temp 
  on temp.id = tmp.mtype 
  ) tmpType where id is not null

     <!-- select distinct b.mtype,b.id 
	 from z_resource a 
	 left join x_resourcetype b on a.MType = b.id and b.flag = 0 
     where a.flag = 0 and b.level = 2 and b.mtype is not null
     <if test="resourceIds.size() == 0">
         and a.id in ('')
     </if>
     <if test="resourceIds.size() > 0 ">
         and a.id in
                <foreach item="item" index="index" collection="resourceIds" 
                         open="(" separator="," close=")">
                         #{item}
                </foreach>
        <if test="typeIds.size() > 0">
        and a.mtype in
                <foreach item="item" index="index" collection="typeIds" 
                         open="(" separator="," close=")">
                         #{item}
                </foreach> 
        </if>
     </if>  -->
  </select>
  
  <!-- e备课， 系统资源：当资源库选择  “动画焦教具”、“名师微课”、“教学案例” 时，显示所有二级类型。 当资源库为“理化生实验”时，只显示“全部”。 -->
  <select id="getSysSecondLevelType_ePrepare"  resultMap="FirstTypeResultMap">
  select DISTINCT id,mtype from (
  select temp.id,temp.mtype from 
  (select DISTINCT a.mtype from z_resource a 
  left join z_resnav c on a.ResCode=c.ResCode
  where a.flag = 0 and c.StructCode like CONCAT(#{pTfcode},'%') and a.fromFlag in 
  <foreach item="item" index="index" collection="sys_from" 
                         open="(" separator="," close=")">
                         #{item}
                </foreach>
  
  ) as tmp
  left join
  (
  SELECT b.id,b.mtype
  from z_res_pooltype a 
  LEFT JOIN x_resourcetype b on a.resTypeId = b.id
  where a.flag=0 and b.flag=0 
   <if test="poolId != 0">   <!-- poolId == 0 时，查询全部资源库下的资源类型 -->
          and poolId = #{poolId} 
     </if>
  UNION 
  SELECT a.id,a.mtype
  from z_res_pooltype b  
  LEFT JOIN x_resourcetype a on a.pid = b.resTypeId 
  where a.flag=0 and b.flag=0 
    <if test="poolId != 0">   <!-- poolId == 0 时，查询全部资源库下的资源类型 -->
          and poolId = #{poolId} 
     </if> 
  ) as temp 
  on temp.id = tmp.mtype 
  ) tmpType where id is not null 
   <if test="removeTypes.size() > 0">   <!-- e备课，去除一些特定类型 -->
          and id not in <foreach item="item" index="index" collection="removeTypes" 
                         open="(" separator="," close=")">
                         #{item}
                </foreach>
     </if>
  </select>
   



   <!-- 系统资源：根据 poolId、父类型typeId, 得到父类型的所有子类型及其自身  -->
  <select id="getTypesByPMTypeAndPool"  resultType="Integer">
     SELECT DISTINCT type_id from 
    (SELECT b.id type_id,b.pid,a.poolId 
     from z_res_pooltype a 
     LEFT JOIN x_resourcetype b on a.resTypeId = b.ID and b.flag=0 
     where a.flag=0 
       <if test="poolId != 0 and MType == 0">
         and poolId = #{poolId}
       </if>
        <if test="MType != 0">
         and (b.id = #{MType} or b.pid = #{MType})
        </if>
      
      UNION all 

      SELECT a.id type_id,a.pid,b.poolId
      from x_resourcetype a 
      LEFT JOIN z_res_pooltype b on a.Pid = b.resTypeId and b.flag=0 
      where a.flag=0 
       <if test="poolId != 0 and MType == 0">
         and poolId = #{poolId}
       </if>
       <if test="MType != 0">
         and (a.id = #{MType} or a.pid = #{MType})
        </if>
      ) temp  
  </select>
  
  <!-- 根据sys_from, 父结点tfcode，查询系统资源的所有id -->
  <resultMap id="SysResIdsMap"  type="Long">
       <result column="sys_id" property="id" />
  </resultMap>
  <select id="getAllSysResIds"  parameterType="HashMap"  resultMap="SysResIdsMap">
      select a.Id sys_id 
      from z_resource a 
      left join z_resnav c on a.ResCode=c.ResCode and c.flag=0 
      left join j_syscourse d on c.StructCode=d.tfcode and d.flag=0 
      where a.flag=0 and a.fromFlag in 
                <foreach item="item" index="index" collection="sys_from" 
                         open="(" separator="," close=")">
                         #{item}
                </foreach>
      and (c.StructCode like CONCAT(#{pTfcode},'%'))
  </select>
  
  
  
 <!-- **************************  区本、校本资源    类型相关   **************************  -->
 
 <!-- 区本校本资源： 资源类型查询 ，fromFlag用以区分校本、区本 -->
  <select id= "getDisResType" resultMap="FirstTypeResultMap">
     select mtype,id from (
     select distinct case when b.PId=0 then b.MType ELSE pb.MType END mtype,case when b.PId=0 then b.id ELSE pb.id END id
     from z_districts_resource a
     LEFT JOIN z_districts_resnav c on a.ResCode=c.ResCode and c.flag=0
     left join x_resourcetype b on a.MType = b.id and b.flag = 0 
     left join x_resourcetype pb on pb.Id = b.pid and (pb.flag = 0)
     where a.flag = 0 and c.StructCode like CONCAT(#{pTfcode},'%') 
     <if test="fromFlag == 3">
         and a.scopeId = #{schoolId} and a.scope = 5 and a.fromFlag = #{fromFlag}
    </if>
     <if test="fromFlag == 4">
         and a.scopeId = #{districtId} and a.scope = 4 and a.fromFlag = #{fromFlag}
    </if>
     order by b.displayIndex
    )tmp where mtype is not null

     <!-- select distinct case when b.PId=0 then b.MType ELSE pb.MType END mtype,case when b.PId=0 then b.id ELSE pb.id END id
     from z_districts_resource a
     left join x_resourcetype b on a.MType = b.id and b.flag = 0 
     left join x_resourcetype pb on pb.Id = b.pid and (pb.flag = 0)
     where a.flag = 0 and a.fromFlag in (#{fromFlag})
     and b.MType is not null and pb.MType is not null
     <if test="resourceIds.size() == 0">
         and a.id in ('')
     </if>
     <if test="resourceIds.size() > 0">
         and a.id in 
                <foreach item="item" index="index" collection="resourceIds" 
                         open="(" separator="," close=")">
                         #{item}
                </foreach>
                
     </if>
     order by b.displayIndex asc   -->
  </select>
  
  <!-- e备课，  区本校本资源： 资源类型查询， fromFlag用以区分校本、区本-->
  <select id= "getDisResType_EPrepare" resultMap="FirstTypeResultMap">
     select mtype,id from (
     select distinct case when b.PId=0 then b.MType ELSE pb.MType END mtype,case when b.PId=0 then b.id ELSE pb.id END id
     from z_districts_resource a
     LEFT JOIN z_districts_resnav c on a.ResCode=c.ResCode and c.flag=0
     left join x_resourcetype b on a.MType = b.id and b.flag = 0 
     left join x_resourcetype pb on pb.Id = b.pid and (pb.flag = 0)
     where a.flag = 0 and c.StructCode like CONCAT(#{pTfcode},'%') 
     <if test="fromFlag == 3">
         and a.scopeId = #{schoolId} and a.scope = 5 and a.fromFlag = #{fromFlag}
    </if>
     <if test="fromFlag == 4">
         and a.scopeId = #{districtId} and a.scope = 4 and a.fromFlag = #{fromFlag}
    </if>
     order by b.displayIndex
    )tmp where mtype is not null 
    <if test="removeTypes.size() > 0">   <!-- e备课，去除一些特定类型 -->
          and id not in <foreach item="item" index="index" collection="removeTypes" 
                         open="(" separator="," close=")">
                         #{item}
                </foreach>
     </if>
  <!--   
  select mtype,id from (
     select distinct case when b.PId=0 then b.MType ELSE pb.MType END mtype,case when b.PId=0 then b.id ELSE pb.id END id
     from z_districts_resource a
     left join x_resourcetype b on a.MType = b.id and b.flag = 0 
     left join x_resourcetype pb on pb.Id = b.pid and (pb.flag = 0)
     where a.flag = 0 and a.fromFlag in (#{fromFlag})
    
     <if test="resourceIds.size() == 0">
         and a.id in ('')
     </if>
     <if test="resourceIds.size() > 0 ">
         and a.id in
                <foreach item="item" index="index" collection="resourceIds" 
                         open="(" separator="," close=")">
                         #{item}
                </foreach>
     </if>)tmp 
     where id not in 
      <foreach item="item" index="index" collection="removeTypeIds" 
                         open="(" separator="," close=")">
                         #{item}
                </foreach>
     and mtype is not null -->
  </select>
  
  
  
  
  
  
  
 
 <!-- 根据父结点tfcode，查询区本、校本资源的所有id -->
  <resultMap id="DisResIdsMap"  type="Long">
       <result column="dis_id" property="id" />
  </resultMap>
  <select id="getAllDisResIds"  parameterType="HashMap"  resultMap="DisResIdsMap"> 
	select a.Id dis_id from z_districts_resource a 
	LEFT JOIN z_districts_resnav c on a.ResCode=c.ResCode and c.flag=0 
	LEFT JOIN j_syscourse d on c.StructCode=d.tfcode and d.flag=0 
    where a.flag=0 and
    c.StructCode like CONCAT(#{pTfcode},'%')
  </select>
 
   <!-- 区本、校本资源：得到父类型的所有子类型及其自身。  -->
  <select id="getDisResTypesByPMType"  resultType="Integer">
      SELECT DISTINCT type_id from (SELECT b.id type_id from x_resourcetype b 
      where b.flag=0 
       <if test="MType != 0">
         and (b.id = #{MType} or b.pid = #{MType})
       </if>
      ) temp 
  </select>
  
 <!-- ************************** e备课 资源类型 相关   **************************  --> 
 
  <!-- 区本校本资源：得到父类型的所有子类型及其自身  -->
  <select id="getDisResTypesByPMType_EPrepare"  resultType="Integer">
      SELECT DISTINCT type_id from (SELECT b.id type_id from x_resourcetype b where b.flag=0 
      <if test="MType != 0">
         and (b.id = #{MType} or b.pid = #{MType})
       </if>
      ) temp 
      
      where type_id not in  
         <foreach item="item" index="index" collection="removeTypeIds" 
                         open="(" separator="," close=")">
                         #{item}
         </foreach> 
  </select>
  
  <!-- 系统资源：得到父类型的所有子类型及其自身  -->
  <select id="getTypesByPMTypeAndPool_EPrepare"  resultType="Integer">
      SELECT DISTINCT type_id from (SELECT b.id type_id,b.pid type_pid,a.poolId poolId,a.id from z_res_pooltype a LEFT JOIN x_resourcetype b on 
      a.resTypeId = b.ID and b.flag=0 where a.flag=0 
      <if test="poolId != 0">
         and poolId = #{poolId}
      </if>
      <if test="MType != 0">
         and (b.id = #{MType} or b.pid = #{MType})
      </if>
      
      UNION all 
      
      SELECT a.id type_id,a.pid type_pid,b.poolId poolId,b.id from  
      x_resourcetype a LEFT JOIN z_res_pooltype b on a.Pid = b.resTypeId and b.flag=0 where a.flag=0 
      <if test="poolId != 0">
         and poolId = #{poolId}
      </if>
       <if test="MType != 0">
         and (a.id = #{MType} or a.pid = #{MType})
      </if>
      ) temp 
      where type_id not in 
         <foreach item="item" index="index" collection="removeTypeIds" 
                         open="(" separator="," close=")">
                         #{item}
                </foreach>
  </select>
  

  <resultMap type="net.tfedu.zhl.cloud.resource.poolTypeFormat.entity.FirstLevelResType" id="firstLevelResTypeMap">
        <id column="id" property="id" />
	   <result column="mtype" property="mtype" />
	   <result column="code" property="code" />
  </resultMap>
  <select id="getAllFirstLevelResType" resultMap="firstLevelResTypeMap">
  		select id,mtype,code from x_resourcetype where flag =false and flag =false and pid = 0 order by displayindex
  </select>
   <select id="getAllResType" resultMap="firstLevelResTypeMap">
  		select id,mtype,code from x_resourcetype where flag =false and flag =false order by displayindex
  </select> 
  
  
</mapper>